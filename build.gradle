plugins {
    id "com.github.johnrengelman.shadow" version "7.0.0"
}

// 全局设置
allprojects {
    apply plugin: 'java'

    group 'github.saukiya'
    version '1.0-SNAPSHOT'

    repositories {
        mavenCentral()

        //Github Project
        maven {url "https://jitpack.io"}
        //bstats-bukkit
        maven {url "https://repo.codemc.org/repository/maven-public"}
    }

    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
}


// 子项目设置
subprojects {
    dependencies {
        compileOnly fileTree('lib')
        compileOnly getRootProject()
        compileOnly 'com.github.PlaceholderAPI:PlaceholderAPI:2.10.9'
        compileOnly 'org.projectlombok:lombok:1.18.22'
        annotationProcessor 'org.projectlombok:lombok:1.18.22'
    }

//    tasks.withType<Classes> {
//        destinationDirectory.set(file("$rootDir/build/libs"))
//    }
}

dependencies {

    implementation 'org.bstats:bstats-bukkit:2.2.1'

    compileOnly fileTree('lib')
    compileOnly 'com.github.PlaceholderAPI:PlaceholderAPI:2.10.9'
    compileOnly 'org.projectlombok:lombok:1.18.22'
    annotationProcessor 'org.projectlombok:lombok:1.18.22'

    getRootProject()
    testImplementation fileTree('lib')
    // getSubprojects().forEach(sub -> testImplementation sub)
    testImplementation 'com.github.PlaceholderAPI:PlaceholderAPI:2.10.9'
    testImplementation 'org.projectlombok:lombok:1.18.22'
    testAnnotationProcessor 'org.projectlombok:lombok:1.18.22'
}

shadowJar {
//    依赖指定task
//    dependsOn(':Module-NMS-V1_8_R3:build', ':Module-NMS-V1_17_R1:build')
    // 过滤未使用的依赖
    minimize()
    // bstats重定向
    relocate('org.bstats', 'github.saukiya.sxitem.bstats')
    // 获得子模块的classes文件
    getSubprojects().forEach(sub -> {
        from(sub.getBuildDir().toString() + '/classes/java/main')
    })
    org.gradle.jvm.tasks.Jar

}

//执行该task前必须执行子模块的task
shadowJar.dependsOn() {
    //执行所有子项目的classes
    getSubprojects().stream().map(sub -> sub.getPath() + ':classes').toList()
}

processResources {
    expand(version: version)
}
